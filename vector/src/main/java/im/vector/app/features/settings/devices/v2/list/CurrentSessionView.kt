/*
 * Copyright (c) 2022 New Vector Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package im.vector.app.features.settings.devices.v2.list

import android.content.Context
import android.util.AttributeSet
import androidx.constraintlayout.widget.ConstraintLayout
import androidx.core.view.isVisible
import im.vector.app.R
import im.vector.app.databinding.ViewCurrentSessionBinding
import im.vector.app.features.settings.devices.TrustUtils
import im.vector.app.features.themes.ThemeUtils
import org.matrix.android.sdk.api.session.crypto.crosssigning.DeviceTrustLevel

class CurrentSessionView @JvmOverloads constructor(
        context: Context,
        attrs: AttributeSet? = null,
        defStyleAttr: Int = 0
) : ConstraintLayout(context, attrs, defStyleAttr) {

    private val views: ViewCurrentSessionBinding

    init {
        inflate(context, R.layout.view_current_session, this)
        views = ViewCurrentSessionBinding.bind(this)
    }

    fun update(accountCrossSigningIsTrusted: Boolean, legacyMode: Boolean) {
        renderDeviceType()
        renderVerificationStatus(accountCrossSigningIsTrusted, legacyMode)
    }

    private fun renderVerificationStatus(accountCrossSigningIsTrusted: Boolean, legacyMode: Boolean) {
        val deviceTrustLevel = DeviceTrustLevel(crossSigningVerified = accountCrossSigningIsTrusted, locallyVerified = true)
        val shield = TrustUtils.shieldForTrust(
                currentDevice = true,
                trustMSK = accountCrossSigningIsTrusted,
                legacyMode = legacyMode,
                deviceTrustLevel = deviceTrustLevel
        )
        views.currentSessionVerificationStatusImageView.render(shield)
        if (deviceTrustLevel.crossSigningVerified) {
            renderCrossSigningVerified()
        } else {
            renderCrossSigningUnverified()
        }
    }

    private fun renderCrossSigningVerified() {
        views.currentSessionVerificationStatusTextView.text = context.getString(R.string.device_manager_verification_status_verified)
        views.currentSessionVerificationStatusTextView.setTextColor(ThemeUtils.getColor(context, R.attr.colorPrimary))
        views.currentSessionVerificationStatusDetailTextView.text = context.getString(R.string.device_manager_verification_status_detail_verified)
        views.currentSessionVerifySessionButton.isVisible = false
    }

    private fun renderCrossSigningUnverified() {
        views.currentSessionVerificationStatusTextView.text = context.getString(R.string.device_manager_verification_status_unverified)
        views.currentSessionVerificationStatusTextView.setTextColor(ThemeUtils.getColor(context, R.attr.colorError))
        views.currentSessionVerificationStatusDetailTextView.text = context.getString(R.string.device_manager_verification_status_detail_unverified)
        views.currentSessionVerifySessionButton.isVisible = true
    }

    // TODO. We don't have this info yet. Update later accordingly.
    private fun renderDeviceType() {
        views.currentSessionDeviceTypeImageView.setImageResource(R.drawable.ic_device_type_mobile)
        views.currentSessionDeviceTypeImageView.contentDescription = context.getString(R.string.a11y_device_manager_device_type_mobile)
        views.currentSessionDeviceTypeTextView.text = context.getString(R.string.device_manager_device_type_android)
    }
}
